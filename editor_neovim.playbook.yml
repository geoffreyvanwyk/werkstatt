---
- name: NeoVim Text Editor
  hosts: all

  tasks:
    - name: Create directory for NeoVim
      become: true
      ansible.builtin.file:
        path: /opt/neovim
        state: directory
        mode: u=rwx,go=rx

    - name: Download NeoVim AppImage
      become: true
      ansible.builtin.get_url:
        url: https://github.com/neovim/neovim/releases/download/v0.9.5/nvim.appimage
        dest: /opt/neovim/nvim.appimage
        mode: u=rwx,g=rx,o=rx

    - name: Extract AppImage
      become: true
      ansible.builtin.command:
        chdir: /opt/neovim
        cmd: ./nvim.appimage --appimage-extract
        creates: /opt/neovim/squashfs-root

    - name: Install NeoVim
      become: true
      ansible.builtin.file:
        src: /opt/neovim/squashfs-root/usr/bin/nvim
        dest: /usr/local/bin/nvim
        state: link
        mode: u=rwx,go=rx

- name: Install AstroNvim
  hosts: all

  tasks:
    - name: Install Treesitter CLI with Cargo
      community.general.cargo:
        name: tree-sitter-cli

    - name: Has AstroNvim templete already been cloned?
      ansible.builtin.stat:
        path: "{{ ansible_env.XDG_CONFIG_HOME }}/nvim"
      register: werkstatt_stat_astronvim 

    - name: Clone AstroNvim template
      when: not werkstatt_stat_astronvim.stat.exists
      ansible.builtin.git:
        repo: https://github.com/AstroNvim/template
        version: main
        depth: 1
        dest: "{{ ansible_env.XDG_CONFIG_HOME }}/nvim"
        update: false

    - name: Delete .git directory from AstroNvim template
      ansible.builtin.file:
        path: "{{ ansible_env.XDG_CONFIG_HOME }}/nvim/.git"
        state: absent
